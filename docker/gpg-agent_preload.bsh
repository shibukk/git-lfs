#!/usr/bin/env bash

set -eu

CUR_DIR=$(dirname ${BASH_SOURCE[0]})
IMAGE_NAME=gpg-agent_debian_8

: ${SUDO=`if ( [ ! -w /var/run/docker.sock ] && id -nG | grep -qwv docker && [ "${DOCKER_HOST:+dh}" != "dh" ] ) && which sudo > /dev/null 2>&1; then echo sudo; fi`}

if [[ $# > 0 ]] && [ "$1" == "-r" ]; then
  ${CUR_DIR}/gpg-agent_stop.bsh
fi

${CUR_DIR}/gpg-agent_start.bsh

#wait at most 10 seconds
for x in $(seq 10); do
  if $SUDO docker exec -it git-lfs-gpg gpg-connect-agent --homedir=/tmp/gpg-agent /bye; then
    break
  else
    sleep 1
  fi
done

#I only need script cause of https://github.com/docker/docker/issues/8755 HORRAY BUGS!
$SUDO docker exec -it git-lfs-gpg script /dev/null -q -c 'gpg2 --homedir=/tmp/gpg-agent -o /dev/null -s /dev/null'
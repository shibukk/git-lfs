#!/usr/bin/env bash

set -eu

chmod 700 /tmp/gpg-agent

for key in $(ls /tmp/*.key); do
  if [ -s $key ]; then
    gpg --homedir /tmp/gpg-agent/ --import $key
  fi
done

eval $(gpg-agent --write-env-file /tmp/gpg-agent/gpg_agent_info \
                 --use-standard-socket --daemon \
                 --default-cache-ttl=${GPG_DEFAULT_CACHE:-31536000} \
                 --max-cache-ttl=${GPG_MAX_CACHE:-31536000} \
                 --homedir /tmp/gpg-agent )

while gpg-connect-agent /bye; do 
  sleep 2
done